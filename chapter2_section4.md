# 2.4 Алгоритм работы системы распознавания

Алгоритм работы системы распознавания лиц представляет собой сложный процесс обработки видеопотока в режиме реального времени с применением методов компьютерного зрения и машинного обучения. Процесс включает несколько последовательных этапов, каждый из которых выполняет специфические функции по преобразованию визуальной информации в результат идентификации.

Инициализация системы начинается с загрузки биометрических отпечатков всех зарегистрированных пользователей из базы данных в оперативную память. Данная операция выполняется однократно при запуске системы и обеспечивает высокую скорость последующих операций сравнения. Биометрические данные представляют собой 128-мерные векторы признаков, извлеченные из фотографий пользователей на этапе регистрации.

```python
def load_facial_encodings(self, encodings, user_ids):
    self.registered_user_encodings = encodings
    self.registered_user_identifiers = user_ids
    print(f"Загружено биометрических отпечатков: {len(self.registered_user_encodings)}")
```

Процесс обработки видеопотока организован в виде циклического алгоритма, который выполняется с частотой около 30 итераций в секунду. На каждой итерации происходит захват текущего кадра с веб-камеры, его обработка алгоритмами компьютерного зрения и принятие решения о наличии и идентичности обнаруженных лиц.

Захват видеокадра осуществляется через интерфейс OpenCV, который обеспечивает стандартизированный доступ к устройствам видеозахвата операционной системы. Полученный кадр представляет собой трехмерный массив пикселей в цветовом пространстве BGR с разрешением, определяемым настройками камеры.

Предварительная обработка кадра включает масштабирование изображения для ускорения последующих вычислений. Коэффициент масштабирования составляет 0.25, что означает уменьшение размеров изображения в четыре раза по каждой оси. Такая оптимизация позволяет сократить время обработки в 16 раз при сохранении достаточной точности обнаружения лиц.

```python
def detect_and_recognize_faces(self, frame, scale=0.25):
    small_frame = cv2.resize(frame, (0, 0), fx=scale, fy=scale)
    rgb_small_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)
    
    face_locations = face_recognition.face_locations(rgb_small_frame)
    face_encodings = face_recognition.face_encodings(rgb_small_frame, face_locations)
```

Обнаружение лиц выполняется алгоритмом на основе гистограммы направленных градиентов, который эффективно выявляет характерные паттерны лиц на изображении. Алгоритм возвращает координаты прямоугольных областей, содержащих обнаруженные лица, в формате верхняя граница, правая граница, нижняя граница, левая граница.

Извлечение биометрических признаков осуществляется сверточной нейронной сетью, обученной на большом наборе данных лиц. Нейронная сеть преобразует изображение лица в 128-мерный вектор признаков, который служит уникальным биометрическим отпечатком. Данный процесс является наиболее вычислительно затратным этапом алгоритма.

Сравнение биометрических отпечатков выполняется путем вычисления евклидова расстояния между вектором признаков обнаруженного лица и векторами всех зарегистрированных пользователей. Для каждого сравнения получается числовое значение расстояния, где меньшее значение указывает на большую степень схожести лиц.

```python
matches = face_recognition.compare_faces(self.registered_user_encodings, face_encoding)
face_distances = face_recognition.face_distance(self.registered_user_encodings, face_encoding)
best_match_index = np.argmin(face_distances)
distance = face_distances[best_match_index]
```

Принятие решения о распознавании основано на двойном пороговом критерии. Первый критерий использует встроенный алгоритм библиотеки face_recognition для определения наличия совпадения. Второй критерий сравнивает численное расстояние с настраиваемым порогом, который по умолчанию составляет 0.6. Лицо считается распознанным только при одновременном выполнении обоих условий.

Система защиты от избыточных срабатываний реализована через механизм временных ограничений. После успешного распознавания пользователя система игнорирует последующие распознавания того же пользователя в течение трех секунд. Аналогично, при обнаружении неизвестного лица система воздерживается от повторного протоколирования в течение пяти секунд.

```python
def _is_known_user_cooldown_expired(self, current_time):
    if not self.last_successful_recognition_timestamp:
        return True
    elapsed_seconds = (current_time - self.last_successful_recognition_timestamp).total_seconds()
    return elapsed_seconds >= RECOGNITION_DELAY
```

Визуализация результатов распознавания включает отрисовку цветных прямоугольников вокруг обнаруженных лиц. Цветовая схема используется для индикации статуса распознавания: зеленый цвет для успешно распознанных пользователей, красный цвет для неизвестных лиц, желтый цвет для состояния ожидания при действии временных ограничений.

Протоколирование событий происходит асинхронно с основным циклом обработки для минимизации влияния на производительность. Каждое событие распознавания фиксируется в базе данных аудита с указанием временной метки, результата операции, идентификатора пользователя и численного значения расстояния схожести.

Обновление пользовательского интерфейса выполняется на каждой итерации цикла обработки. Обработанный видеокадр с нанесенными аннотациями отображается в соответствующем элементе интерфейса. При успешном распознавании пользователя обновляется информационная панель с данными о пользователе и его фотографией.

Обработка ошибочных ситуаций встроена в каждый этап алгоритма. При отсутствии доступа к камере система корректно завершает цикл обработки и информирует пользователя о проблеме. В случае повреждения кадра или невозможности извлечения признаков система пропускает текущую итерацию и продолжает обработку следующих кадров.

Оптимизация производительности достигается через несколько технических решений. Масштабирование кадров снижает вычислительную нагрузку без критического ухудшения качества распознавания. Векторизованные операции сравнения позволяют одновременно сравнивать текущий отпечаток со всеми зарегистрированными пользователями. Кэширование биометрических данных в оперативной памяти исключает необходимость обращения к базе данных при каждой операции сравнения.

Алгоритм адаптации к изменяющимся условиям включает автоматическую настройку параметров обработки в зависимости от качества видеопотока. При недостаточном освещении система может временно снизить частоту обработки кадров для обеспечения более точного анализа. В условиях высокой вычислительной нагрузки система приоритизирует обработку кадров с обнаруженными лицами.

Завершение работы алгоритма происходит при остановке камеры пользователем или закрытии приложения. Система корректно освобождает все задействованные ресурсы, включая подключение к камере и временные буферы обработки изображений. Все незавершенные операции протоколирования завершаются перед окончательным завершением работы системы.